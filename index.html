<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>잔금 할인(지원) 계산기</title>
  <style>
    :root { --b:#e5e7eb; --t:#111827; --m:#6b7280; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
           margin: 0; background:#fafafa; color:var(--t); }
    .wrap { max-width: 920px; margin: 28px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid var(--b); border-radius:14px; padding:18px; box-shadow:0 1px 6px rgba(0,0,0,.04); }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 820px){ .grid { grid-template-columns:1fr; } }
    label { display:block; font-size: 12px; color: var(--m); margin-bottom: 6px; }
    input, select { width:100%; padding:10px 12px; border:1px solid var(--b); border-radius:10px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color:#9ca3af; box-shadow:0 0 0 3px rgba(156,163,175,.25); }
    .row { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    .btn { appearance:none; border:1px solid var(--b); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn.secondary { background:#fff; color:#111827; }
    .hint { font-size:12px; color:var(--m); line-height:1.5; margin-top:10px; }
    .out { margin-top:14px; padding-top:14px; border-top:1px solid var(--b); }
    .kpi { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    @media (max-width: 820px){ .kpi { grid-template-columns:1fr; } }
    .kpi .box { border:1px solid var(--b); border-radius:12px; padding:12px; background:#fcfcfc; }
    .kpi .box .tt { font-size:12px; color:var(--m); }
    .kpi .box .vv { font-size:18px; margin-top:6px; font-weight:700; }
    .warn { margin-top:10px; padding:10px 12px; border-radius:12px; background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; font-size: 13px; display:none; }
    .ok { margin-top:10px; padding:10px 12px; border-radius:12px; background:#ecfeff; border:1px solid #a5f3fc; color:#155e75; font-size: 13px; display:none; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>잔금 할인(지원) 계산기</h1>

      <div class="grid">
        <div>
          <label>잔금금액(원)</label>
          <input id="amount" type="text" inputmode="numeric" placeholder="예: 143300000" value="143300000" />
          <div class="hint">숫자만 입력해도 되고, 쉼표가 있어도 자동 처리됩니다.</div>
        </div>

        <div>
          <label>잔금 납부일</label>
          <input id="payDate" type="date" value="2026-02-01" />
          <div class="hint">예시: 2026-02-01</div>
        </div>

        <div>
          <label>시작일(지원 산정 시작)</label>
          <input id="startDate" type="date" value="2026-01-23" />
        </div>

        <div>
          <label>입주개시일(참고용)</label>
          <input id="moveInDate" type="date" value="2026-02-23" />
          <div class="hint">문구에 “입주개시일 이후 30일 이내”가 있어 참고로 표시해두었습니다.</div>
        </div>

        <div>
          <label>연이율(%)</label>
          <input id="rate" type="number" step="0.01" value="7" />
        </div>

        <div>
          <label>최장 적용일수(일)</label>
          <input id="maxDays" type="number" step="1" value="100" />
        </div>

        <div>
          <label>최소 잔금금액(원) - 이 금액 이상부터 지원</label>
          <input id="minAmount" type="text" inputmode="numeric" value="10000000" />
        </div>

        <div>
          <label>적용일수 계산 방식</label>
          <select id="mode">
            <option value="calendarReverse">달력일 역산: 적용일수 = 최장일수 - (시작일~납부일 경과일)</option>
            <option value="businessReverse">영업일 역산(주말 제외) + 납부일 1일 포함</option>
            <option value="manualDays">적용일수 직접 입력</option>
          </select>
          <div class="hint">안내문/관리사무소 기준과 다를 수 있어 선택형으로 만들었습니다.</div>
        </div>

        <div id="manualWrap" style="display:none;">
          <label>적용일수(직접 입력)</label>
          <input id="manualDays" type="number" step="1" min="0" value="93" />
          <div class="hint">예: 93</div>
        </div>
      </div>

      <div class="row" style="margin-top:14px;">
        <button class="btn" id="calcBtn">계산하기</button>
        <button class="btn secondary" id="copyBtn" type="button">결과 요약 복사</button>
      </div>

      <div class="warn" id="warnBox"></div>
      <div class="ok" id="okBox"></div>

      <div class="out">
        <div class="kpi">
          <div class="box">
            <div class="tt">일 이자(원/일) = 잔금 × 연이율 ÷ 365</div>
            <div class="vv mono" id="perDay">-</div>
          </div>
          <div class="box">
            <div class="tt">적용일수(일) (0 ~ 최장일수로 제한)</div>
            <div class="vv mono" id="days">-</div>
          </div>
          <div class="box">
            <div class="tt">할인(지원)금액(원) = 일 이자 × 적용일수</div>
            <div class="vv mono" id="discount">-</div>
          </div>

          <!-- 추가: 최종 납부금액 -->
          <div class="box">
            <div class="tt">최종 납부금액(원) = 잔금금액 − 할인(지원)금액</div>
            <div class="vv mono" id="finalPay">-</div>
          </div>
        </div>

        <div class="hint" id="detail"></div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function parseMoney(v){
    if (v == null) return 0;
    const n = String(v).replace(/[^\d.-]/g, "");
    return n ? Number(n) : 0;
  }

  function fmtMoney(n){
    if (!Number.isFinite(n)) return "-";
    return Math.round(n).toLocaleString("ko-KR");
  }

  function toDateOnly(d){
    // local date (no timezone surprise)
    const dt = new Date(d + "T00:00:00");
    return dt;
  }

  function diffDaysCalendar(start, end){
    // start~end 경과일수: end - start (일수), start==end => 0
    const ms = toDateOnly(end) - toDateOnly(start);
    return Math.floor(ms / 86400000);
  }

  function countBusinessDaysInclusive(start, end){
    // start~end를 훑되, 주말(토/일)은 제외
    // 단, 납부일(end)은 주말이어도 "납부한 날"로 1일 포함 처리 옵션을 위해 별도 가산 가능
    const s = toDateOnly(start);
    const e = toDateOnly(end);
    if (e < s) return 0;

    let count = 0;
    let cur = new Date(s);
    while (cur <= e){
      const day = cur.getDay(); // 0=일,6=토
      if (day !== 0 && day !== 6) count++;
      cur.setDate(cur.getDate() + 1);
    }
    return count;
  }

  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

  function calc(){
    const amount = parseMoney($("amount").value);
    const minAmount = parseMoney($("minAmount").value);
    const ratePct = Number($("rate").value);
    const maxDays = Number($("maxDays").value);

    const payDate = $("payDate").value;
    const startDate = $("startDate").value;
    const moveInDate = $("moveInDate").value;
    const mode = $("mode").value;

    const warnBox = $("warnBox");
    const okBox = $("okBox");
    warnBox.style.display = "none";
    okBox.style.display = "none";
    warnBox.textContent = "";
    okBox.textContent = "";

    if (!payDate || !startDate){
      warnBox.textContent = "날짜를 모두 입력해 주세요.";
      warnBox.style.display = "block";
      return;
    }
    if (!Number.isFinite(amount) || amount <= 0){
      warnBox.textContent = "잔금금액을 올바르게 입력해 주세요.";
      warnBox.style.display = "block";
      return;
    }
    if (!Number.isFinite(ratePct) || ratePct < 0){
      warnBox.textContent = "연이율(%)을 올바르게 입력해 주세요.";
      warnBox.style.display = "block";
      return;
    }
    if (!Number.isFinite(maxDays) || maxDays <= 0){
      warnBox.textContent = "최장 적용일수를 올바르게 입력해 주세요.";
      warnBox.style.display = "block";
      return;
    }

    const rate = ratePct / 100;
    const perDayRaw = (amount * rate) / 365;

    // 예시처럼 "일 이자"를 원 단위로 버림(floor) 처리
    const perDay = Math.floor(perDayRaw);

    let appliedDays = 0;
    let detail = "";

    if (mode === "manualDays"){
      appliedDays = Number($("manualDays").value);
      if (!Number.isFinite(appliedDays)) appliedDays = 0;
      appliedDays = clamp(Math.floor(appliedDays), 0, maxDays);
      detail = `직접 입력 모드: 적용일수 = ${appliedDays}일 (0~${maxDays} 제한)`;
    } else if (mode === "businessReverse"){
      const bizIncl = countBusinessDaysInclusive(startDate, payDate);
      // 납부일이 주말이면(토/일) bizIncl에 포함되지 않으므로 "납부일 1일 포함"을 위해 +1
      const payDow = toDateOnly(payDate).getDay();
      const addPayDay = (payDow === 0 || payDow === 6) ? 1 : 0;
      const elapsed = bizIncl + addPayDay; // start 포함 영업일 + 납부일 1일
      appliedDays = clamp(maxDays - elapsed, 0, maxDays);
      detail =
        `영업일 역산: (시작일~납부일까지의 영업일 수)=${bizIncl}일, 납부일 주말 포함 가산=${addPayDay}일 → 경과=${elapsed}일 → 적용=${appliedDays}일 (최장 ${maxDays}일)`;
    } else {
      // calendarReverse
      const elapsed = diffDaysCalendar(startDate, payDate);
      appliedDays = clamp(maxDays - elapsed, 0, maxDays);
      detail =
        `달력일 역산: 시작일~납부일 경과=${elapsed}일(시작일 동일=0) → 적용=${appliedDays}일 (최장 ${maxDays}일)`;
    }

    const discount = perDay * appliedDays;

    // 추가: 최종 납부금액(음수 방지)
    const finalPay = Math.max(0, amount - discount);

    $("perDay").textContent = fmtMoney(perDay) + " 원";
    $("days").textContent = fmtMoney(appliedDays) + " 일";
    $("discount").textContent = fmtMoney(discount) + " 원";
    $("finalPay").textContent = fmtMoney(finalPay) + " 원";

    // 조건 체크: 최소 금액
    if (amount < minAmount){
      warnBox.textContent = `지원 불가: 잔금금액(${fmtMoney(amount)}원)이 최소금액(${fmtMoney(minAmount)}원) 미만입니다.`;
      warnBox.style.display = "block";
    } else {
      okBox.textContent = `지원 가능: 잔금금액이 최소금액 이상입니다.`;
      okBox.style.display = "block";
    }

    // 입주개시일 이후 30일 이내 문구가 있어 참고 경고(계산엔 반영 안 함)
    if (moveInDate){
      const d = diffDaysCalendar(moveInDate, payDate); // pay - moveIn
      if (d > 30){
        warnBox.style.display = "block";
        warnBox.textContent += (warnBox.textContent ? " " : "") +
          `참고: 납부일이 입주개시일(${moveInDate}) 이후 ${d}일이라 “30일 이내” 조건에 해당하지 않을 수 있습니다.`;
      }
    }

    $("detail").textContent = detail + ` | 일 이자=${fmtMoney(perDay)}원(=⌊${(perDayRaw).toFixed(4)}⌋)`;
  }

  function syncManualUI(){
    const mode = $("mode").value;
    $("manualWrap").style.display = (mode === "manualDays") ? "block" : "none";
  }

  $("calcBtn").addEventListener("click", calc);
  $("mode").addEventListener("change", () => { syncManualUI(); calc(); });

  $("copyBtn").addEventListener("click", async () => {
    const txt =
`[잔금 할인(지원) 계산 결과]
- 잔금금액: ${$("amount").value}
- 납부일: ${$("payDate").value}
- 시작일: ${$("startDate").value}
- 연이율: ${$("rate").value}%
- 최장 적용일수: ${$("maxDays").value}일
- 일 이자: ${$("perDay").textContent}
- 적용일수: ${$("days").textContent}
- 할인(지원)금액: ${$("discount").textContent}
- 최종 납부금액: ${$("finalPay").textContent}
- 상세: ${$("detail").textContent}`;
    try{
      await navigator.clipboard.writeText(txt);
      const ok = $("okBox");
      ok.style.display = "block";
      ok.textContent = "결과 요약을 클립보드에 복사했습니다.";
    }catch(e){
      const w = $("warnBox");
      w.style.display = "block";
      w.textContent = "복사 권한이 없어 복사에 실패했습니다. 브라우저 설정을 확인해 주세요.";
    }
  });

  // 숫자 입력 UX: 금액 입력 중 자동 정리
  ["amount","minAmount"].forEach(id=>{
    $(id).addEventListener("blur", () => {
      const n = parseMoney($(id).value);
      if (Number.isFinite(n) && n >= 0) $(id).value = n.toLocaleString("ko-KR");
    });
  });

  syncManualUI();
  calc();
</script>
</body>
</html>
